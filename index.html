<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>English for Schools â€” Prospect 3</title>

  <!-- ÙÙˆÙ†Øª Ùˆ Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/Farsi-Digits/Vazir-FD.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --bg1:#0b1220; --bg2:#1b2b4a; --surface:#121a2d; --surface2:#0f1a32;
      --text:#eaf3ff; --muted:#9bb3cc; --border:#2a4068; --accent:#13d38b; --accent2:#71d7ff;
      --shadow:0 12px 36px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:linear-gradient(160deg,var(--bg1),var(--bg2));color:var(--text);font-family:'Vazir',Tahoma}
    .hidden{display:none!important}

    /* Topbar */
    .topbar{
      position:sticky;top:0;z-index:60;display:flex;align-items:center;justify-content:space-between;
      padding:10px 16px;background:linear-gradient(90deg,#0f1a32cc,#101a31cc);
      backdrop-filter:blur(6px);border-bottom:1px solid var(--border)
    }
    .brand{font-weight:900;color:#cfe7ff;display:flex;align-items:center;gap:8px}
    .left-actions,.right-actions{display:flex;gap:8px;align-items:center}
    .btn{cursor:pointer;border:none;border-radius:12px;padding:10px 14px;font-weight:800;transition:.2s}
    .btn--primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#06233a;box-shadow:0 8px 20px rgba(19,211,139,.25)}
    .btn--outline{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btn--ghost{background:#1b294a;color:#fff;border:1px solid #243a60}
    .btn:hover{transform:translateY(-2px);filter:brightness(1.06)}
    .btn:active{transform:scale(.98)}

    /* Layout */
    .container{width:min(1200px,94vw);margin:0 auto;padding:16px}
    .card{background:linear-gradient(145deg,var(--surface),var(--surface2));border:1px solid var(--border);border-radius:20px;box-shadow:var(--shadow);padding:20px}
    .tip{color:var(--muted);font-size:.92rem}

    /* Lesson grid */
    .grid{display:grid;gap:14px}
    .grid.lessons{grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    .pill{
      background:#16274b;border:1px solid var(--border);border-radius:16px;padding:18px;text-align:center;
      font-weight:800;display:flex;align-items:center;justify-content:center;gap:10px;
      transition:.2s;box-shadow:0 6px 14px rgba(0,0,0,.25)
    }
    .pill:hover{transform:translateY(-3px);border-color:#3a5fa0}

    /* Pages */
    .flip-nav{display:flex;align-items:center;justify-content:space-between;margin:12px 0}
    .page{
      background:linear-gradient(160deg,#101a31,#0d182f);
      border:1px solid var(--border);border-radius:18px;padding:18px;margin:16px 0;box-shadow:var(--shadow);
      opacity:0;transform:translateY(16px);animation:fadeIn .5s ease forwards
    }
    .page h2{margin:0 0 10px;color:#cfe7ff;border-bottom:1px solid #233a60;padding-bottom:8px}
    .section{margin:10px 0 16px;padding:12px;border:1px dashed var(--border);border-radius:12px;background:#0e1a30}
    .section h3{margin:0 0 8px;color:#9bd6ff}
    .line{display:flex;align-items:center;gap:10px;margin:6px 0}
    .en{direction:ltr;text-align:left;font-family:Tahoma,Arial;color:#eaf8ff;letter-spacing:.2px}
    .fa{direction:rtl;text-align:right}
    .word{cursor:pointer;border-bottom:1px dashed #3a5fa0}
    .word:hover{color:#71d7ff}
    .audio-row{display:flex;align-items:center;gap:10px;margin:8px 0}

    /* Modal */
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:16px;background:rgba(8,14,26,.6);z-index:1000;animation:fadeModal .25s ease}
    .modal-content{width:min(900px,96vw);background:#0f1a32;border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

    /* Footer designer */
    .designer{
      position:fixed;left:16px;bottom:16px;z-index:70;
      background:#0f1a32cc;border:1px solid #243a60;border-radius:14px;padding:10px;display:flex;align-items:center;gap:10px;
      box-shadow:0 10px 24px rgba(0,0,0,.35);backdrop-filter:blur(6px)
    }
    .designer img{width:42px;height:42px;border-radius:50%;border:1px solid #2a4068}
    .designer small{color:#cfe7ff;font-weight:700;letter-spacing:.2px}

    /* Animations */
    @keyframes fadeIn{to{opacity:1;transform:translateY(0)}}
    @keyframes fadeModal{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
  </style>
</head>
<body>

  <!-- Topbar -->
  <header class="topbar">
    <div class="brand"><i class="fa-solid fa-book-open"></i> English for Schools â€” Prospect 3</div>
    <div class="left-actions">
      <button class="btn btn--ghost" id="bgmToggle" type="button"><i class="fa-solid fa-music"></i> Ù…ÙˆØ³ÛŒÙ‚ÛŒ Ø²Ù…ÛŒÙ†Ù‡</button>
    </div>
    <div class="right-actions">
      <button class="btn btn--outline" onclick="showModal('helpModal')" type="button"><i class="fa-regular fa-circle-question"></i> Ø±Ø§Ù‡Ù†Ù…Ø§</button>
      <button class="btn btn--primary" onclick="showModal('irregularModal')" type="button"><i class="fa-solid fa-bolt"></i> Ø§ÙØ¹Ø§Ù„ Ø¨ÛŒâ€ŒÙ‚Ø§Ø¹Ø¯Ù‡</button>
    </div>
  </header>

  <!-- Start screen -->
  <section class="container" id="startScreen">
    <div class="card">
      <h1 style="margin:0 0 8px">Prospect 3 â€” Flipbook ØªØ¹Ø§Ù…Ù„ÛŒ</h1>
      <p class="tip">Lessons â€¢ Conversation â€¢ Practice â€¢ Language melody â€¢ Grammar â€¢ Find it â€¢ Listening A/B â€¢ Workbook â€¢ Exams</p>

      <h2 style="margin:14px 0 8px">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø±Ø³</h2>
      <div class="grid lessons" id="lessonButtons"></div>
    </div>
  </section>

  <!-- Lesson screen -->
  <main id="lessonScreen" class="hidden">
    <div class="container">
      <div class="flip-nav">
        <button class="btn btn--outline" onclick="prevPage()" type="button"><i class="fa-solid fa-chevron-right"></i> Ù‚Ø¨Ù„</button>
        <div id="lessonTitle" style="font-weight:900;color:#cfe7ff"></div>
        <button class="btn btn--outline" onclick="nextPage()" type="button">Ø¨Ø¹Ø¯ <i class="fa-solid fa-chevron-left"></i></button>
      </div>

      <div id="pages"></div>

      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button class="btn btn--ghost" onclick="goBack()" type="button"><i class="fa-solid fa-rotate-left"></i> Ø¨Ø§Ø²Ú¯Ø´Øª</button>
      </div>
    </div>
  </main>

  <!-- Help modal -->
  <div class="modal hidden" id="helpModal">
    <div class="modal-content">
      <h2><i class="fa-regular fa-circle-question"></i> Ø±Ø§Ù‡Ù†Ù…Ø§</h2>
      <div class="fa">
        <div>â€¢ Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ú†Ù¾â€ŒÚ†ÛŒÙ† Ùˆ Ø¨Ø§ Ø¬Ù‡Øª LTR Ù‡Ø³ØªÙ†Ø¯.</div>
        <div>â€¢ Ø±ÙˆÛŒ ÙˆØ§Ú˜Ù‡â€ŒÙ‡Ø§ÛŒ Ø¢Ø¨ÛŒ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ Ù…Ø¹Ù†ÛŒØŒ Ù…ØªØ±Ø§Ø¯ÙØŒ Ú©Ù„Ù…Ø§Øª Ù…Ø±ØªØ¨Ø· Ùˆ Ù…Ø«Ø§Ù„ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯.</div>
        <div>â€¢ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ğŸ”Š Ø¨Ø±Ø§ÛŒ ØªÙ„ÙØ¸ Ø¬Ù…Ù„Ù‡/ÙˆØ§Ú˜Ù‡ ÙØ¹Ø§Ù„ Ù‡Ø³ØªÙ†Ø¯.</div>
        <div>â€¢ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¨Ø®Ø´ Ø¯Ú©Ù…Ù‡Ù” Ù¾Ø®Ø´ ØµÙˆØª Ú©Ø§Ù…Ù„ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯.</div>
      </div>
      <div class="modal-actions">
        <button class="btn btn--outline" type="button" onclick="closeModal('helpModal')"><i class="fa-solid fa-xmark"></i> Ø¨Ø³ØªÙ†</button>
      </div>
    </div>
  </div>

  <!-- Irregular verbs modal -->
  <div class="modal hidden" id="irregularModal">
    <div class="modal-content">
      <h2><i class="fa-solid fa-bolt"></i> Ø§ÙØ¹Ø§Ù„ Ø¨ÛŒâ€ŒÙ‚Ø§Ø¹Ø¯Ù‡</h2>
      <div id="irregularBody" class="fa"></div>
      <div class="modal-actions">
        <button class="btn btn--outline" type="button" onclick="closeModal('irregularModal')"><i class="fa-solid fa-xmark"></i> Ø¨Ø³ØªÙ†</button>
      </div>
    </div>
  </div>

  <!-- Word meaning modal -->
  <div class="modal hidden" id="wordModal">
    <div class="modal-content">
      <h3 id="wmWord" class="en"></h3>
      <div id="wmBody" class="fa"></div>
      <div class="modal-actions">
        <button class="btn btn--primary" type="button" onclick="speak(document.getElementById('wmWord').textContent)">ğŸ”Š ØªÙ„ÙØ¸</button>
        <button class="btn btn--outline" type="button" onclick="closeModal('wordModal')">Ø¨Ø³ØªÙ†</button>
      </div>
    </div>
  </div>

  <!-- Designer footer (fixed across pages) -->
  <div class="designer">
    <img src="https://s34.picofile.com/file/8488183492/2.png" alt="Designer">
    <small>Designer â€” A.R. Yousefzadeh</small>
  </div>

  <script>
    /* ------------------ Background music + click sound ------------------ */
    const bgm = new Audio();
    bgm.src = "https://cdn.pixabay.com/download/audio/2023/03/01/audio_76b5d8b3c7.mp3?filename=serene-background-14065.mp3"; // Ù†Ù…ÙˆÙ†Ù‡ Ø¢Ø²Ø§Ø¯Ø› Ø¯Ø± ØµÙˆØ±Øª ØªÙ…Ø§ÛŒÙ„ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯
    bgm.loop = true; bgm.volume = 0.25;
    const clickSound = new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_7d6ce6b2d7.mp3?filename=click-124467.mp3");
    clickSound.volume = 0.35;
    function playClick(){ try{ clickSound.currentTime=0; clickSound.play(); }catch{} }
    document.querySelectorAll('.btn,.pill').forEach(el=> el.addEventListener('click', playClick));
    document.getElementById('bgmToggle').addEventListener('click', ()=>{
      if(bgm.paused){ bgm.play(); document.getElementById('bgmToggle').innerHTML = '<i class="fa-solid fa-music"></i> Ù…ÙˆØ³ÛŒÙ‚ÛŒ Ø²Ù…ÛŒÙ†Ù‡: Ø±ÙˆØ´Ù†'; }
      else { bgm.pause(); document.getElementById('bgmToggle').innerHTML = '<i class="fa-solid fa-music"></i> Ù…ÙˆØ³ÛŒÙ‚ÛŒ Ø²Ù…ÛŒÙ†Ù‡: Ø®Ø§Ù…ÙˆØ´'; }
    });

    /* ------------------ Dictionary and helpers ------------------ */
    const DICT = {
      // Ù†Ù…ÙˆÙ†Ù‡â€ŒÙ‡Ø§Ø› Ù„Ø·ÙØ§Ù‹ ÙˆØ§Ú˜Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ Ù‡Ø± Ø¯Ø±Ø³ Ø±Ø§ Ú©Ø§Ù…Ù„ Ú©Ù†ÛŒØ¯
      clever:{ fa:"Ø¨Ø§Ù‡ÙˆØ´/Ø²Ø±Ù†Ú¯", syn:["smart","bright"], rel:["intelligent"], ex:"He is a clever student.", exFa:"Ø§Ùˆ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¨Ø§Ù‡ÙˆØ´ÛŒ Ø§Ø³Øª." },
      kind:{ fa:"Ù…Ù‡Ø±Ø¨Ø§Ù†", syn:["nice","friendly"], rel:["polite"], ex:"She is kind to everyone.", exFa:"Ø§Ùˆ Ø¨Ø§ Ù‡Ù…Ù‡ Ù…Ù‡Ø±Ø¨Ø§Ù† Ø§Ø³Øª." },
      reservation:{ fa:"Ø±Ø²Ø±Ùˆ", syn:["booking"], rel:["ticket"], ex:"I have a reservation.", exFa:"Ù…Ù† Ø±Ø²Ø±Ùˆ Ø¯Ø§Ø±Ù…." },
      passport:{ fa:"Ú¯Ø°Ø±Ù†Ø§Ù…Ù‡", syn:["ID"], rel:["visa"], ex:"Show your passport, please.", exFa:"Ù„Ø·ÙØ§Ù‹ Ú¯Ø°Ø±Ù†Ø§Ù…Ù‡â€ŒØ§Øª Ø±Ø§ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡." },
      gift:{ fa:"Ù‡Ø¯ÛŒÙ‡", syn:["present"], rel:["reward"], ex:"They get gifts in Norooz.", exFa:"Ø¢Ù†â€ŒÙ‡Ø§ Ø¯Ø± Ù†ÙˆØ±ÙˆØ² Ù‡Ø¯ÛŒÙ‡ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ù†Ø¯." }
    };
    function inlineWords(s){
      return String(s).replace(/\b([A-Za-z][A-Za-z\-']+)\b/g,(m)=>{
        const k=m.toLowerCase();
        return `<span class="word" onclick="openWord('${k}')">${m}</span>`;
      });
    }
    function openWord(w){
      const info = DICT[w] || {fa:"â€”", syn:[], rel:[], ex:"", exFa:""};
      document.getElementById('wmWord').textContent = w;
      document.getElementById('wmBody').innerHTML = `
        <div><b>Ù…Ø¹Ù†ÛŒ:</b> ${info.fa}</div>
        ${info.syn?.length?`<div><b>Ù…ØªØ±Ø§Ø¯Ùâ€ŒÙ‡Ø§:</b> ${info.syn.join(", ")}</div>`:""}
        ${info.rel?.length?`<div><b>Ú©Ù„Ù…Ø§Øª Ù…Ø±ØªØ¨Ø·:</b> ${info.rel.join(", ")}</div>`:""}
        ${info.ex?`<div style="margin-top:6px"><b>Ù…Ø«Ø§Ù„:</b> <span class="en">${info.ex}</span></div>`:""}
        ${info.exFa?`<div class="fa">${info.exFa}</div>`:""}
      `;
      showModal('wordModal');
    }
    function speak(text){
      try{
        if(!window.speechSynthesis){ alert('Speech Synthesis Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.'); return; }
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US'; window.speechSynthesis.speak(u);
      }catch(e){}
    }

    /* ------------------ Listening links provided by you ------------------ */
    const LISTENING = {
      1:{ A:"https://s34.picofile.com/file/8488257092/6A.mp3.html", B:"https://s34.picofile.com/file/8488257100/6B.mp3.html" },
      2:{ A:"https://s34.picofile.com/file/8488257218/026_A.mp3.html", B:"https://s34.picofile.com/file/8488257226/026_B.mp3.html" },
      3:{ A:"https://s34.picofile.com/file/8488257234/036_A.mp3.html", B:"https://s34.picofile.com/file/8488257242/036_B.mp3.html" },
      4:{ A:"https://s34.picofile.com/file/8488257250/046_A.mp3.html", B:"https://s34.picofile.com/file/8488257268/046_B.mp3.html" },
      5:{ A:"https://s34.picofile.com/file/8488257326/056_A.mp3.html", B:"https://s34.picofile.com/file/8488257350/056_B.mp3.html" },
      6:{ A:"https://s34.picofile.com/file/8488257376/066_A.mp3.html", B:"https://s34.picofile.com/file/8488257400/066_B.mp3.html" }
    };

    /* ------------------ Lessons data structure (to be filled from SB9/WB9) ------------------ */
    // Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ù‡Ø± Ø¨Ø®Ø´ Ø±Ø§ Ø§Ø² PDFÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.
    // Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡ØŒ Ø¯Ø±Ø³ 1 ÙÙ‚Ø· Ù‚Ø§Ù„Ø¨ Ø¯Ø§Ø±Ø¯ Ùˆ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ù…Ø­ØªÙˆØ§ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ SB9/WB9 Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø´ÙˆØ¯.
    const LESSONS = [
      {
        id:1, title:"Lesson 1 â€” (Ù…ÙˆØ¶ÙˆØ¹ SB9)", topics:["Conversation","Practice 1","Practice 2","Language melody","Sentences below","Grammar","Find it","Listening A","Listening B","Workbook","Photo Dictionary"],
        sections:{
          conversation:{
            text:[
              // Ø§ÛŒÙ†â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ø² SB9 ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯Ø› Ù‡Ø± Ø®Ø· ÛŒÚ© Ø¬Ù…Ù„Ù‡
              "Ehsan: ...",
              "Parham: ..."
            ],
            audio:"" // Ø§Ú¯Ø± ÙØ§ÛŒÙ„ ØµÙˆØªÛŒ Ú©Ø§Ù…Ù„ Ø¨Ø®Ø´ Ø¯Ø§Ø±ÛŒØ¯ØŒ Ù„ÛŒÙ†Ú© Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯
          },
          practice1:{ text:[ "..." ], audio:"" },
          practice2:{ text:[ "..." ], audio:"" },
          languageMelody:{ text:[ "..." ], audio:"" },
          sentencesBelow:{ text:[ "..." ] },
          grammar:{ title:"...", description:"...", examples:[ "..." ] },
          findIt:{ text:[ "..." ] },
          listeningA:{ transcript:[ "..." ], audio: LISTENING[1].A },
          listeningB:{ transcript:[ "..." ], audio: LISTENING[1].B },
          workbook:{
            exercises:[
              // ØªÙ…Ø±ÛŒÙ† ØªØ¹Ø§Ù…Ù„ÛŒ Ù†Ù…ÙˆÙ†Ù‡Ø› Ù¾Ø§Ø³Ø®Ù†Ø§Ù…Ù‡ Ù¾Ù†Ù‡Ø§Ù†
              { type:"fill", q:"They __ kind.", key:"are", explain:"Be verb plural", answer:"are" },
              { type:"mcq", q:"He __ clever.", options:["are","is"], key:"is", explain:"Be verb singular", answer:"is" }
            ],
            answersVisible:false
          },
          photoDictionary:[
            { phrase:"school bag", fa:"Ú©ÛŒÙ Ù…Ø¯Ø±Ø³Ù‡", example:"This is my school bag.", exFa:"Ø§ÛŒÙ† Ú©ÛŒÙ Ù…Ø¯Ø±Ø³Ù‡â€ŒÛŒ Ù…Ù† Ø§Ø³Øª." },
          ]
        },
        exam:{
          points:20,
          items:[
            { type:"mcq", q:"Choose the correct verb: He __ clever.", options:["are","is"], key:"is" },
            { type:"fill", q:"They __ kind.", key:"are" },
            { type:"tf", q:"Reservation means booking.", key:true }
          ]
        }
      },
      // ... Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ 2 ØªØ§ 6 Ø±Ø§ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù…Ø«Ù„ Ø¯Ø±Ø³ 1 Ø¨Ø§ Ù…ØªÙ† ÙˆØ§Ù‚Ø¹ÛŒ SB9/WB9 Ù¾Ø± Ú©Ù†ÛŒØ¯
      { id:2, title:"Lesson 2 â€” (Ù…ÙˆØ¶ÙˆØ¹ SB9)", topics:[/*...*/], sections:{ /* Ù…Ø§Ù†Ù†Ø¯ Ø¨Ø§Ù„Ø§ */ }, exam:{ points:20, items:[] } },
      { id:3, title:"Lesson 3 â€” (Ù…ÙˆØ¶ÙˆØ¹ SB9)", topics:[/*...*/], sections:{ /* Ù…Ø§Ù†Ù†Ø¯ Ø¨Ø§Ù„Ø§ */ }, exam:{ points:20, items:[] } },
      { id:4, title:"Lesson 4 â€” (Ù…ÙˆØ¶ÙˆØ¹ SB9)", topics:[/*...*/], sections:{ /* Ù…Ø§Ù†Ù†Ø¯ Ø¨Ø§Ù„Ø§ */ }, exam:{ points:20, items:[] } },
      { id:5, title:"Lesson 5 â€” (Ù…ÙˆØ¶ÙˆØ¹ SB9)", topics:[/*...*/], sections:{ /* Ù…Ø§Ù†Ù†Ø¯ Ø¨Ø§Ù„Ø§ */ }, exam:{ points:20, items:[] } },
      { id:6, title:"Lesson 6 â€” (Ù…ÙˆØ¶ÙˆØ¹ SB9)", topics:[/*...*/], sections:{ /* Ù…Ø§Ù†Ù†Ø¯ Ø¨Ø§Ù„Ø§ */ }, exam:{ points:20, items:[] } }
    ];

    /* ------------------ UI build ------------------ */
    const lessonButtons = document.getElementById('lessonButtons');
    LESSONS.forEach(lesson=>{
      const btn = document.createElement('button');
      btn.className = "pill";
      btn.innerHTML = `<i class="fa-solid fa-book"></i> ${lesson.title}`;
      btn.addEventListener('click', ()=> loadLesson(lesson.id));
      lessonButtons.appendChild(btn);
    });

    let pages = []; let pageIndex = 0; let currentLesson = null;

    function sectionBlock(title, lines=[], opts={}){
      const speakAllBtn = opts.audio ? `<button class="btn btn--primary" type="button" onclick="playAudio('${opts.audio}')">ğŸ”Š Ù¾Ø®Ø´ ØµÙˆØª Ø¨Ø®Ø´</button>` : "";
      const rendered = (lines||[]).map(line=>{
        const safe = line.replace(/"/g,'&quot;').replace(/'/g,"\\'");
        return `<div class="line">
          <span class="en">${inlineWords(line)}</span>
          <button class="btn btn--outline" type="button" onclick="speak('${safe}')">ğŸ”Š</button>
        </div>`;
      }).join("");
      return `
        <div class="page">
          <h2>${title}</h2>
          ${speakAllBtn?`<div class="audio-row">${speakAllBtn}</div>`:""}
          <div class="section">
            ${rendered || `<div class="fa">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ù…ØªÙ† Ø§Ø² SB9/WB9...</div>`}
          </div>
        </div>
      `;
    }

    function vocabBlock(lesson){
      const vocab = (lesson.sections.vocab || lesson.sections?.photoDictionary?.map(p=>p.phrase)) || [];
      const rows = (vocab||[]).map(w=>{
        const info = DICT[w?.toLowerCase()] || {fa:"â€”",ex:"",exFa:""};
        return `
          <div class="line">
            <span class="en word" onclick="openWord('${(w||'').toLowerCase()}')">${w}</span>
            <span class="fa">â€” ${info.fa}</span>
            <button class="btn btn--outline" type="button" onclick="speak('${w}')">ğŸ”Š</button>
          </div>
          ${info.ex?`<div class="en" style="margin:0 0 8px 26px">${info.ex}</div>`:""}
          ${info.exFa?`<div class="fa" style="margin:0 0 8px 26px">${info.exFa}</div>`:""}
        `;
      }).join("");
      return `
        <div class="page">
          <h2>Lesson vocabulary</h2>
          <div class="section">${rows || `<div class="fa">Ù„ÛŒØ³Øª ÙˆØ§Ú˜Ù‡Ù” Ø¯Ø±Ø³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.</div>`}</div>
        </div>
      `;
    }

    function workbookBlock(exercises){
      const rows = (exercises||[]).map((ex,i)=>{
        const id = `wb_${i}`;
        if(ex.type==="fill"){
          return `
            <div class="section">
              <div class="line fa"><b>Ø³ÙˆØ§Ù„:</b> ${ex.q}</div>
              <div class="line"><input id="${id}" type="text" placeholder="Ù¾Ø§Ø³Ø® Ø´Ù…Ø§..." style="padding:8px;border-radius:8px;border:1px solid #2a4068;background:#0f1a32;color:#eaf3ff">
                <button class="btn btn--ghost" type="button" onclick="checkFill('${id}','${ex.key}')">Ø¨Ø±Ø±Ø³ÛŒ</button>
                <button class="btn btn--outline" type="button" onclick="toggleAnswer('${id}_ans')">Ù†Ù…Ø§ÛŒØ´ Ù¾Ø§Ø³Ø®</button>
              </div>
              <div id="${id}_ans" class="hidden fa"><b>Ù¾Ø§Ø³Ø®:</b> ${ex.answer || ex.key} â€” <i>${ex.explain||''}</i></div>
            </div>
          `;
        }
        if(ex.type==="mcq"){
          const opts = ex.options.map(o=>`<label style="margin-left:10px"><input type="radio" name="${id}" value="${o}"> ${o}</label>`).join("");
          return `
            <div class="section">
              <div class="line fa"><b>Ø³ÙˆØ§Ù„:</b> ${ex.q}</div>
              <div class="line">${opts}</div>
              <div class="line">
                <button class="btn btn--ghost" type="button" onclick="checkMCQ('${id}','${ex.key}')">Ø¨Ø±Ø±Ø³ÛŒ</button>
                <button class="btn btn--outline" type="button" onclick="toggleAnswer('${id}_ans')">Ù†Ù…Ø§ÛŒØ´ Ù¾Ø§Ø³Ø®</button>
              </div>
              <div id="${id}_ans" class="hidden fa"><b>Ù¾Ø§Ø³Ø®:</b> ${ex.key} â€” <i>${ex.explain||''}</i></div>
            </div>
          `;
        }
        if(ex.type==="tf"){
          return `
            <div class="section">
              <div class="line fa"><b>Ø³ÙˆØ§Ù„:</b> ${ex.q}</div>
              <div class="line">
                <label style="margin-left:10px"><input type="radio" name="${id}" value="true"> Ø¯Ø±Ø³Øª</label>
                <label><input type="radio" name="${id}" value="false"> Ù†Ø§Ø¯Ø±Ø³Øª</label>
              </div>
              <div class="line">
                <button class="btn btn--ghost" type="button" onclick="checkTF('${id}','${ex.key}')">Ø¨Ø±Ø±Ø³ÛŒ</button>
                <button class="btn btn--outline" type="button" onclick="toggleAnswer('${id}_ans')">Ù†Ù…Ø§ÛŒØ´ Ù¾Ø§Ø³Ø®</button>
              </div>
              <div id="${id}_ans" class="hidden fa"><b>Ù¾Ø§Ø³Ø®:</b> ${ex.key? 'Ø¯Ø±Ø³Øª':'Ù†Ø§Ø¯Ø±Ø³Øª'}</div>
            </div>
          `;
        }
        return "";
      }).join("");
      return `
        <div class="page">
          <h2>Workbook â€” ØªÙ…Ø±ÛŒÙ†Ø§Øª ØªØ¹Ø§Ù…Ù„ÛŒ</h2>
          ${rows || `<div class="section fa">ØªÙ…Ø±ÛŒÙ†â€ŒÙ‡Ø§ÛŒ WB9 Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.</div>`}
        </div>
      `;
    }

    function examBlock(exam){
      const rows = (exam?.items||[]).map((it,i)=>{
        const id = `ex_${i}`;
        if(it.type==="fill"){
          return `
            <div class="section">
              <div class="line fa"><b>Ø³ÙˆØ§Ù„:</b> ${it.q}</div>
              <div class="line"><input id="${id}" type="text" placeholder="Ù¾Ø§Ø³Ø®..." style="padding:8px;border-radius:8px;border:1px solid #2a4068;background:#0f1a32;color:#eaf3ff">
                <button class="btn btn--ghost" type="button" onclick="checkFill('${id}','${it.key}')">Ø¨Ø±Ø±Ø³ÛŒ</button>
                <button class="btn btn--outline" type="button" onclick="toggleAnswer('${id}_ans')">Ù†Ù…Ø§ÛŒØ´ Ù¾Ø§Ø³Ø®</button>
              </div>
              <div id="${id}_ans" class="hidden fa"><b>Ù¾Ø§Ø³Ø®:</b> ${it.key}</div>
            </div>
          `;
        }
        if(it.type==="mcq"){
          const opts = it.options.map(o=>`<label style="margin-left:10px"><input type="radio" name="${id}" value="${o}"> ${o}</label>`).join("");
          return `
            <div class="section">
              <div class="line fa"><b>Ø³ÙˆØ§Ù„:</b> ${it.q}</div>
              <div class="line">${opts}</div>
              <div class="line">
                <button class="btn btn--ghost" type="button" onclick="checkMCQ('${id}','${it.key}')">Ø¨Ø±Ø±Ø³ÛŒ</button>
                <button class="btn btn--outline" type="button" onclick="toggleAnswer('${id}_ans')">Ù†Ù…Ø§ÛŒØ´ Ù¾Ø§Ø³Ø®</button>
              </div>
              <div id="${id}_ans" class="hidden fa"><b>Ù¾Ø§Ø³Ø®:</b> ${it.key}</div>
            </div>
          `;
        }
        if(it.type==="tf"){
          return `
            <div class="section">
              <div class="line fa"><b>Ø³ÙˆØ§Ù„:</b> ${it.q}</div>
              <div class="line">
                <label style="margin-left:10px"><input type="radio" name="${id}" value="true"> Ø¯Ø±Ø³Øª</label>
                <label><input type="radio" name="${id}" value="false"> Ù†Ø§Ø¯Ø±Ø³Øª</label>
              </div>
              <div class="line">
                <button class="btn btn--ghost" type="button" onclick="checkTF('${id}','${it.key}')">Ø¨Ø±Ø±Ø³ÛŒ</button>
                <button class="btn btn--outline" type="button" onclick="toggleAnswer('${id}_ans')">Ù†Ù…Ø§ÛŒØ´ Ù¾Ø§Ø³Ø®</button>
              </div>
              <div id="${id}_ans" class="hidden fa"><b>Ù¾Ø§Ø³Ø®:</b> ${it.key? 'Ø¯Ø±Ø³Øª':'Ù†Ø§Ø¯Ø±Ø³Øª'}</div>
            </div>
          `;
        }
        return "";
      }).join("");
      return `
        <div class="page">
          <h2>Exam â€” 20 pts</h2>
          ${rows || `<div class="section fa">Ø³ÙˆØ§Ù„Ø§Øª Ø¢Ø²Ù…ÙˆÙ† Ø§ÛŒÙ† Ø¯Ø±Ø³ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.</div>`}
        </div>
      `;
    }

    function listeningBlock(title, part, lessonId){
      const audioLink = LISTENING[lessonId]?.[part];
      return `
        <div class="page">
          <h2>${title} â€” Part ${part}</h2>
          <div class="section">
            <div class="audio-row">
              <button class="btn btn--primary" type="button" onclick="openAudio('${audioLink}')">ğŸ”Š Ù¾Ø®Ø´ ÙØ§ÛŒÙ„ Ø´Ù†ÛŒØ¯Ø§Ø±ÛŒ (${part})</button>
            </div>
            <div class="fa tip">Ù…ØªÙ† Ø´Ù†ÛŒØ¯Ø§Ø±ÛŒ Ø±Ø§ Ø§Ø² SB9/WB9 Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.</div>
          </div>
        </div>
      `;
    }

    function loadLesson(id){
      currentLesson = LESSONS.find(l=>l.id===id);
      document.getElementById('startScreen').classList.add('hidden');
      document.getElementById('lessonScreen').classList.remove('hidden');
      document.getElementById('lessonTitle').textContent = currentLesson.title;

      pages = [];
      // Ø¨Ø®Ø´ ÙˆØ§Ú˜Ú¯Ø§Ù† Ø¯Ø±Ø³
      pages.push(vocabBlock(currentLesson));

      // Conversation
      pages.push(sectionBlock("Conversation", currentLesson.sections.conversation.text, {audio: currentLesson.sections.conversation.audio}));

      // Practice 1 & 2
      pages.push(sectionBlock("Practice 1", currentLesson.sections.practice1.text, {audio: currentLesson.sections.practice1.audio}));
      pages.push(sectionBlock("Practice 2", currentLesson.sections.practice2.text, {audio: currentLesson.sections.practice2.audio}));

      // Language melody & sentences below
      pages.push(sectionBlock("Language melody", currentLesson.sections.languageMelody.text, {audio: currentLesson.sections.languageMelody.audio}));
      pages.push(sectionBlock("Sentences below", currentLesson.sections.sentencesBelow.text));

      // Grammar
      pages.push(`
        <div class="page">
          <h2>Grammar</h2>
          <div class="section fa">
            <button class="btn btn--outline" type="button" onclick="toggleAnswer('gr_${id}')">Ù†Ù…Ø§ÛŒØ´ ØªÙˆØ¶ÛŒØ­Ø§Øª Ú¯Ø±Ø§Ù…Ø±</button>
            <div id="gr_${id}" class="hidden">
              <div><b>${currentLesson.sections.grammar.title || 'â€”'}</b></div>
              <div>${currentLesson.sections.grammar.description || 'â€”'}</div>
              ${(currentLesson.sections.grammar.examples||[]).map(e=>`<div class="en">${inlineWords(e)}</div>`).join("")}
            </div>
          </div>
        </div>
      `);

      // Find it
      pages.push(sectionBlock("Find it", currentLesson.sections.findIt.text));

      // Listening A/B
      pages.push(listeningBlock("Listening", "A", id));
      pages.push(listeningBlock("Listening", "B", id));

      // Workbook
      pages.push(workbookBlock(currentLesson.sections.workbook.exercises));

      // Photo Dictionary (Ø¯Ø±Ø³ Ø¨Ù‡ Ø¯Ø±Ø³)
      pages.push(`
        <div class="page">
          <h2>Photo Dictionary</h2>
          <div class="section">
            ${(currentLesson.sections.photoDictionary||[]).map(p=>`
              <div class="line">
                <span class="en word" onclick="openWord('${p.phrase.toLowerCase()}')">${p.phrase}</span>
                <span class="fa">â€” ${p.fa}</span>
                <button class="btn btn--outline" type="button" onclick="speak('${p.phrase.replace(/'/g,"\\'")}')">ğŸ”Š</button>
              </div>
              ${p.example?`<div class="en" style="margin:0 0 8px 26px">${inlineWords(p.example)}</div>`:""}
              ${p.exFa?`<div class="fa" style="margin:0 0 8px 26px">${p.exFa}</div>`:""}
            `).join("") || `<div class="fa">Ø¹Ø¨Ø§Ø±Ø§Øª Photo Dictionary Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¯Ø±Ø³ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.</div>`}
          </div>
        </div>
      `);

      // Exam (20 pts)
      pages.push(examBlock(currentLesson.exam));

      pageIndex = 0;
      renderPages();
      highlightPage();
    }

    function renderPages(){
      const wrap = document.getElementById('pages');
      wrap.innerHTML = "";
      pages.forEach((html,i)=>{
        const tmp = document.createElement('div');
        tmp.innerHTML = html.trim();
        const page = tmp.firstElementChild;
        page.dataset.index = i;
        wrap.appendChild(page);
      });
    }
    function highlightPage(){
      document.querySelectorAll('.page').forEach((p,i)=>{
        p.style.opacity = (i===pageIndex) ? '1' : '0';
        p.style.pointerEvents = (i===pageIndex) ? 'auto' : 'none';
        p.style.transition = 'opacity .25s ease';
      });
    }
    function prevPage(){ const n=pageIndex-1; if(n>=0){ pageIndex=n; highlightPage(); } }
    function nextPage(){ const n=pageIndex+1; if(n<pages.length){ pageIndex=n; highlightPage(); } }
    function goBack(){
      document.getElementById('lessonScreen').classList.add('hidden');
      document.getElementById('startScreen').classList.remove('hidden');
      currentLesson=null; pages=[]; pageIndex=0;
    }

    /* ------------------ Modal controls ------------------ */
    function showModal(id){ document.getElementById(id).classList.remove('hidden'); }
    function closeModal(id){ document.getElementById(id).classList.add('hidden'); }
    document.addEventListener('keydown',(e)=>{
      if(e.key==='Escape'){
        const open=document.querySelector('.modal:not(.hidden)');
        if(open) open.classList.add('hidden');
      }
      if(e.key==='ArrowRight') nextPage();
      if(e.key==='ArrowLeft') prevPage();
    });
    ['helpModal','irregularModal','wordModal'].forEach(id=>{
      const m=document.getElementById(id);
      m.addEventListener('click',(e)=>{
        const content=m.querySelector('.modal-content');
        if(content && !content.contains(e.target)) m.classList.add('hidden');
      });
    });

    /* ------------------ Workbook/exam checkers ------------------ */
    function toggleAnswer(id){ const el=document.getElementById(id); if(!el) return; el.classList.toggle('hidden'); }
    function checkFill(id,key){
      const el=document.getElementById(id); if(!el) return;
      const val=(el.value||"").trim().toLowerCase();
      const ok = val === String(key).toLowerCase();
      el.style.outline = ok ? '2px solid #13d38b' : '2px solid #ff6e6e';
    }
    function checkMCQ(name,key){
      const picked = document.querySelector(`input[name="${name}"]:checked`);
      if(!picked) return;
      const ok = picked.value === key;
      const wrap = picked.closest('.section');
      if(wrap) wrap.style.boxShadow = ok ? '0 0 0 2px #13d38b inset' : '0 0 0 2px #ff6e6e inset';
    }
    function checkTF(name,key){
      const picked = document.querySelector(`input[name="${name}"]:checked`);
      if(!picked) return;
      const ok = String(picked.value)===(key?'true':'false');
      const wrap = picked.closest('.section');
      if(wrap) wrap.style.boxShadow = ok ? '0 0 0 2px #13d38b inset' : '0 0 0 2px #ff6e6e inset';
    }

    /* ------------------ Audio openers ------------------ */
    function playAudio(src){
      if(!src){ alert('Ù„ÛŒÙ†Ú© ØµÙˆØªÛŒ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù‡Ù†ÙˆØ² ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.'); return; }
      openAudio(src);
    }
    function openAudio(url){
      try{
        window.open(url,'_blank','noopener');
      }catch(e){
        location.href = url;
      }
    }

    /* ------------------ Irregular verbs ------------------ */
    const IRREGULAR = [
      { base:"be", past:"was/were", fa:"Ø¨ÙˆØ¯Ù† â€” Ø¨ÙˆØ¯/Ø¨ÙˆØ¯Ù†Ø¯", exBase:"I am happy.", exPast:"I was happy.", exFaBase:"Ù…Ù† Ø®ÙˆØ´Ø­Ø§Ù„Ù….", exFaPast:"Ù…Ù† Ø®ÙˆØ´Ø­Ø§Ù„ Ø¨ÙˆØ¯Ù…." },
      { base:"go", past:"went", fa:"Ø±ÙØªÙ† â€” Ø±ÙØª", exBase:"They go to school.", exPast:"They went to school.", exFaBase:"Ø¢Ù†â€ŒÙ‡Ø§ Ø¨Ù‡ Ù…Ø¯Ø±Ø³Ù‡ Ù…ÛŒâ€ŒØ±ÙˆÙ†Ø¯.", exFaPast:"Ø¢Ù†â€ŒÙ‡Ø§ Ø¨Ù‡ Ù…Ø¯Ø±Ø³Ù‡ Ø±ÙØªÙ†Ø¯." },
      { base:"break", past:"broke", fa:"Ø´Ú©Ø³ØªÙ† â€” Ø´Ú©Ø³Øª", exBase:"He breaks the rule.", exPast:"He broke the rule.", exFaBase:"Ø§Ùˆ Ù‚Ø§Ù†ÙˆÙ† Ø±Ø§ Ù…ÛŒâ€ŒØ´Ú©Ù†Ø¯.", exFaPast:"Ø§Ùˆ Ù‚Ø§Ù†ÙˆÙ† Ø±Ø§ Ø´Ú©Ø³Øª." },
      { base:"buy", past:"bought", fa:"Ø®Ø±ÛŒØ¯Ù† â€” Ø®Ø±ÛŒØ¯", exBase:"We buy food.", exPast:"We bought food.", exFaBase:"Ù…Ø§ ØºØ°Ø§ Ù…ÛŒâ€ŒØ®Ø±ÛŒÙ….", exFaPast:"Ù…Ø§ ØºØ°Ø§ Ø®Ø±ÛŒØ¯ÛŒÙ…." }
    ];
    const irregularBody = document.getElementById('irregularBody');
    irregularBody.innerHTML = IRREGULAR.map(v=>`
      <div class="section">
        <div class="line"><b>Base:</b> <span class="en word" onclick="openWord('${v.base}')">${v.base}</span> â€” <b>Past:</b> <span class="en word" onclick="openWord('${v.past}')">${v.past}</span></div>
        <div class="fa tip">${v.fa}</div>
        <div class="line">
          <span class="en">${inlineWords(v.exBase)}</span>
          <button class="btn btn--outline" type="button" onclick="speak('${v.exBase.replace(/'/g,"\\'")}')">ğŸ”Š</button>
        </div>
        <div class="fa">${v.exFaBase}</div>
        <div class="line">
          <span class="en">${inlineWords(v.exPast)}</span>
          <button class="btn btn--outline" type="button" onclick="speak('${v.exPast.replace(/'/g,"\\'")}')">ğŸ”Š</button>
        </div>
        <div class="fa">${v.exFaPast}</div>
      </div>
    `).join("");

  </script>
</body>
</html>
