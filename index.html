<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prospect 3 â€” Flipbook ØªØ¹Ø§Ù…Ù„ÛŒ</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0b1220; --surface:#121a2d; --text:#e9f1ff; --muted:#9bb3cc;
      --border:#2a4068; --accent:#13d38b; --accent2:#71d7ff;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:Tahoma,Segoe UI,Arial}
    .hidden{display:none}

    /* Topbar */
    .topbar{
      position:sticky;top:0;z-index:20;height:60px;background:#111a2fcc;
      backdrop-filter:blur(6px);border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;padding:0 12px;
    }
    .brand{font-weight:800;letter-spacing:.3px}
    .btn{cursor:pointer;border:none;border-radius:10px;padding:10px 14px}
    .btn--primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#06233a;font-weight:800}
    .btn--outline{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btn--ghost{background:#1b294a;color:#fff}

    /* Layout */
    .container{width:min(1050px,95vw);margin:0 auto;padding:12px}
    .card{
      background:linear-gradient(160deg,#10192f,#0d1630);border:1px solid var(--border);
      border-radius:18px;box-shadow:0 20px 50px rgba(0,0,0,.35);padding:16px
    }

    /* Grids */
    .grid{display:grid;gap:10px}
    .grid.lessons{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .grid.tools{grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    .pill{
      background:#16274b;border:1px solid var(--border);border-radius:14px;padding:14px;
      color:#eaf3ff;display:flex;align-items:center;justify-content:space-between;font-weight:700
    }

    /* Flipbook */
    .flip-nav{display:flex;align-items:center;justify-content:space-between;margin:8px 0}
    .flip{width:min(1050px,95vw);margin:0 auto}
    .page{
      background:var(--surface);border:1px solid var(--border);border-radius:14px;margin:16px 0;padding:16px
    }
    .page h2{margin-top:0;color:#cfe7ff;border-bottom:1px solid #233a60;padding-bottom:6px}

    /* Content */
    .section{margin:8px 0 14px;padding:10px;border:1px dashed var(--border);border-radius:12px}
    .section h3{margin:0 0 6px;color:#9bd6ff}
    .text{line-height:1.9}
    .word{cursor:pointer;border-bottom:1px dashed var(--border)}
    .word:hover{color:var(--accent2)}

    /* Exercises */
    .exercise{padding:8px;border-radius:10px;background:#0f1a32;border:1px solid var(--border);margin-bottom:8px}
    .controls{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .answer{display:none;margin-top:6px;color:#bde8ff}
    .answer.show{display:block}
    .correct{outline:2px solid #13d38b}
    .incorrect{outline:2px solid #ff6e6e}

    /* Modal & popup */
    .modal{position:fixed;inset:0;background:rgba(6,12,24,.55);display:flex;align-items:center;justify-content:center;padding:12px;z-index:100}
    .modal-content{width:min(880px,95vw);background:#0f1a32;border:1px solid var(--border);border-radius:16px;padding:14px}
    .popup{position:fixed;bottom:20px;right:20px;z-index:110}
    .popup-content{width:min(420px,92vw);background:#0f1a32;border:1px solid var(--border);border-radius:14px}
    .popup-head{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid #233a60}
    #popupWord{font-weight:800;color:#9bd6ff}
    .popup-body{padding:10px}
  </style>
</head>
<body>

  <!-- Topbar -->
  <header class="topbar">
    <button class="btn btn--primary" id="openGlossary">ÙˆØ§Ú˜Ù‡â€ŒÙ†Ø§Ù…Ù‡Ù” ØªØ¹Ø§Ù…Ù„ÛŒ</button>
    <div class="brand">Prospect 3 â€” Flipbook ØªØ¹Ø§Ù…Ù„ÛŒ</div>
    <div style="display:flex;gap:8px">
      <button class="btn btn--ghost" id="irregularBtn">Ø§ÙØ¹Ø§Ù„ Ø¨ÛŒâ€ŒÙ‚Ø§Ø¹Ø¯Ù‡</button>
      <button class="btn btn--outline" id="helpBtn">Ø±Ø§Ù‡Ù†Ù…Ø§</button>
    </div>
  </header>

  <!-- Start screen -->
  <section class="container" id="startScreen">
    <div class="card">
      <h1 style="margin:0 0 8px">English for Schools â€” Prospect 3</h1>
      <p style="margin:0;color:var(--muted)">Lessons â€¢ Practice â€¢ Workbook â€¢ Audio â€¢ Dictionary â€¢ Exams</p>

      <h2 style="margin:14px 0 8px">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø±Ø³</h2>
      <div class="grid lessons">
        <button class="pill lesson-btn" data-lesson="1"><span>Lesson 1</span><small>&nbsp;Personality</small></button>
        <button class="pill lesson-btn" data-lesson="2"><span>Lesson 2</span><small>&nbsp;Travel</small></button>
        <button class="pill lesson-btn" data-lesson="3"><span>Lesson 3</span><small>&nbsp;Festivals</small></button>
      </div>

      <h2 style="margin:14px 0 8px">Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§</h2>
      <div class="grid lessons">
        <button class="pill exam-btn" data-exam="midterm-1-3">Midterm â€” Lessons 1â€“3</button>
      </div>
    </div>
  </section>

  <!-- Flipbook -->
  <main id="flipbookArea" class="hidden">
    <div class="container">
      <div class="flip-nav">
        <button class="btn btn--outline" id="prevPage">â€¹</button>
        <div id="currentTitle" style="font-weight:800;color:#cfe7ff"></div>
        <button class="btn btn--outline" id="nextPage">â€º</button>
      </div>
      <div class="flip" id="flipbook"></div>
      <div style="display:flex;justify-content:flex-end">
        <button class="btn btn--outline" id="backBtn">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
      </div>
    </div>
  </main>

  <!-- Help modal -->
  <div class="modal hidden" id="helpModal" aria-hidden="true">
    <div class="modal-content">
      <h2>Ø±Ø§Ù‡Ù†Ù…Ø§</h2>
      <div class="text">
        <div>â€¢ Ø¨Ø§ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ â€¹ Ùˆ â€º Ø¨ÛŒÙ† ØµÙØ­Ø§Øª Ø¬Ø§Ø¨Ù‡â€ŒØ¬Ø§ Ø´ÙˆÛŒØ¯.</div>
        <div>â€¢ Ø±ÙˆÛŒ ÙˆØ§Ú˜Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ Ù…Ø¹Ù†ÛŒ Ùˆ Ù…Ø«Ø§Ù„ Ø¨Ø¨ÛŒÙ†ÛŒØ¯.</div>
        <div>â€¢ Ø¨Ø±Ø§ÛŒ ØªÙ„ÙØ¸ØŒ Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ğŸ”Š Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.</div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn btn--outline" id="closeHelp">Ø¨Ø³ØªÙ†</button>
      </div>
    </div>
  </div>

  <!-- Irregular verbs modal -->
  <div class="modal hidden" id="verbsModal" aria-hidden="true">
    <div class="modal-content">
      <h2>Ø§ÙØ¹Ø§Ù„ Ø¨ÛŒâ€ŒÙ‚Ø§Ø¹Ø¯Ù‡</h2>
      <div id="verbsBody"></div>
      <div style="margin-top:10px;display:flex;justify-content:flex-end;gap:8px">
        <button class="btn btn--outline" id="closeVerbs">Ø¨Ø³ØªÙ†</button>
      </div>
    </div>
  </div>

  <!-- Glossary modal with fully working buttons -->
  <div class="modal hidden" id="glossaryModal" aria-hidden="true">
    <div class="modal-content">
      <h2>ÙˆØ§Ú˜Ù‡â€ŒÙ†Ø§Ù…Ù‡Ù” ØªØ¹Ø§Ù…Ù„ÛŒ</h2>

      <!-- Search -->
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <input id="glInput" type="text" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ ÙˆØ§Ú˜Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ..." style="flex:1;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0f1a32;color:#eaf4ff"/>
        <button class="btn btn--outline" id="glSpeak">ğŸ”Š ØªÙ„ÙØ¸</button>
      </div>
      <div id="glResult" style="margin-top:10px;border:1px dashed var(--border);border-radius:12px;padding:10px;background:#0f1a32"></div>

      <!-- Mini practice inside glossary -->
      <div style="margin-top:14px" id="glBody">
        <div class="exercise" data-key="are">
          <div><b>Q:</b> They __ kind.</div>
          <div class="controls">
            <input type="text" placeholder="are / is"/>
            <div class="answer"><b>Answer:</b> are</div>
          </div>
        </div>
        <div class="exercise" data-key="is">
          <div><b>Q:</b> He __ clever. (is/are)</div>
          <div class="controls">
            <input type="text" placeholder="is / are"/>
            <div class="answer"><b>Answer:</b> is</div>
          </div>
        </div>
      </div>

      <!-- Action buttons -->
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap">
        <button class="btn btn--primary" id="glSubmit">Ø«Ø¨Øª Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§</button>
        <button class="btn btn--outline" id="glShow">Ù†Ù…Ø§ÛŒØ´ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§</button>
        <button class="btn btn--outline" id="glClear">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
        <button class="btn btn--outline" id="glClose">Ø¨Ø³ØªÙ†</button>
      </div>
    </div>
  </div>

  <!-- Word popup -->
  <div class="popup hidden" id="wordPopup" aria-hidden="true">
    <div class="popup-content">
      <div class="popup-head">
        <span id="popupWord"></span>
        <div style="display:flex;gap:8px">
          <button class="btn btn--outline" id="popupSpeak">ğŸ”Š ØªÙ„ÙØ¸</button>
          <button class="btn btn--outline" id="popupClose">âœ•</button>
        </div>
      </div>
      <div class="popup-body" id="popupBody"></div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function(){
      /* ---------- Data ---------- */
      const LESSONS = [
        {
          id:1, title:"Lesson 1 â€” Personality",
          sections:[
            { type:"conversation", title:"Conversation", text:`Ehsan: Who is your best friend at school?
Parham: Reza.
Ehsan: What's he like?
Parham: He is clever and kind.` },
            { type:"practice", title:"Practice â€” Yes/No", items:[
              { q:"Is he clever?", a:"Yes, he is." },
              { q:"Are you kind?", a:"Yes, I am." }
            ]},
            { type:"listening", title:"Listening A", audio:"", text:`Iran is a great country. People are kind and friendly.` }
          ]
        },
        {
          id:2, title:"Lesson 2 â€” Travel",
          sections:[
            { type:"conversation", title:"Conversation", text:`Receptionist: Welcome to our hotel. Do you have a reservation?
Tourist: Yes, my name is Paul.` },
            { type:"practice", title:"Practice â€” Travel", items:[
              { q:"Do you have a reservation?", a:"Yes, I do." },
              { q:"Where is your passport?", a:"It's here." }
            ]}
          ]
        },
        {
          id:3, title:"Lesson 3 â€” Festivals & Ceremonies",
          sections:[
            { type:"conversation", title:"Conversation", text:`Elham: We usually visit our relatives in Norooz.
Nasrin: We get gifts, too!` }
          ]
        }
      ];

      const DICT = {
        "clever": { fa:"Ø¨Ø§Ù‡ÙˆØ´", syn:["smart","bright"], rel:["intelligent"], ex:"He is a clever student." },
        "kind": { fa:"Ù…Ù‡Ø±Ø¨Ø§Ù†", syn:["nice","friendly"], rel:["polite"], ex:"She is kind to everyone." },
        "reservation": { fa:"Ø±Ø²Ø±Ùˆ", syn:["booking"], rel:["ticket"], ex:"I have a reservation." },
        "gift": { fa:"Ù‡Ø¯ÛŒÙ‡", syn:["present"], rel:["money"], ex:"They get gifts in Norooz." },
        "passport": { fa:"Ú¯Ø°Ø±Ù†Ø§Ù…Ù‡", syn:["ID"], rel:["visa"], ex:"Show your passport, please." }
      };

      /* ---------- Elements ---------- */
      const startScreen = document.getElementById('startScreen');
      const flipbookArea = document.getElementById('flipbookArea');
      const flipbookEl = document.getElementById('flipbook');
      const currentTitleEl = document.getElementById('currentTitle');
      const prevPageBtn = document.getElementById('prevPage');
      const nextPageBtn = document.getElementById('nextPage');
      const backBtn = document.getElementById('backBtn');

      const helpBtn = document.getElementById('helpBtn');
      const helpModal = document.getElementById('helpModal');
      const closeHelp = document.getElementById('closeHelp');

      const irregularBtn = document.getElementById('irregularBtn');
      const verbsModal = document.getElementById('verbsModal');
      const closeVerbs = document.getElementById('closeVerbs');
      const verbsBody = document.getElementById('verbsBody');

      const openGlossary = document.getElementById('openGlossary');
      const glossaryModal = document.getElementById('glossaryModal');
      const glClose = document.getElementById('glClose');
      const glSubmit = document.getElementById('glSubmit');
      const glShow = document.getElementById('glShow');
      const glClear = document.getElementById('glClear');
      const glInput = document.getElementById('glInput');
      const glResult = document.getElementById('glResult');
      const glSpeak = document.getElementById('glSpeak');
      const glBody = document.getElementById('glBody');

      const wordPopup = document.getElementById('wordPopup');
      const popupWord = document.getElementById('popupWord');
      const popupBody = document.getElementById('popupBody');
      const popupSpeak = document.getElementById('popupSpeak');
      const popupClose = document.getElementById('popupClose');

      let currentLesson = null;
      let pages = [];
      let pageIndex = 0;

      /* ---------- Safe bindings ---------- */
      // Start: lessons
      document.querySelectorAll('.lesson-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = parseInt(btn.dataset.lesson,10);
          loadLesson(id);
        });
      });
      // Start: exams (demo alert)
      document.querySelectorAll('.exam-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          alert('Ø¯Ø± Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡ØŒ Ø¢Ø²Ù…ÙˆÙ† Ø¯Ø± ÙˆØ§Ú˜Ù‡â€ŒÙ†Ø§Ù…Ù‡Ù” ØªØ¹Ø§Ù…Ù„ÛŒ Ø¨Ù‡â€ŒØµÙˆØ±Øª Ú©ÙˆÚ†Ú© Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.');
          openGlossaryModal();
        });
      });

      // Topbar modals
      helpBtn.addEventListener('click', ()=> helpModal.classList.remove('hidden'));
      closeHelp.addEventListener('click', ()=> helpModal.classList.add('hidden'));

      irregularBtn.addEventListener('click', ()=>{
        renderIrregular();
        verbsModal.classList.remove('hidden');
      });
      closeVerbs.addEventListener('click', ()=> verbsModal.classList.add('hidden'));

      // Glossary open/close
      function openGlossaryModal(){
        glossaryModal.classList.remove('hidden');
        glInput.value="";
        glResult.innerHTML = `<div style="color:${getComputedStyle(document.body).getPropertyValue('--muted')}">ÛŒÚ© ÙˆØ§Ú˜Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...</div>`;
        // reset practice UI
        glBody.querySelectorAll('.exercise input').forEach(i=>{
          i.value = "";
          i.classList.remove('correct','incorrect');
        });
        glBody.querySelectorAll('.answer').forEach(a=> a.classList.remove('show'));
      }
      openGlossary.addEventListener('click', openGlossaryModal);
      glClose.addEventListener('click', ()=> glossaryModal.classList.add('hidden'));

      // Glossary actions â€” WORKING handlers
      glSubmit.addEventListener('click', ()=>{
        const items = glBody.querySelectorAll('.exercise');
        let score=0,total=0;
        items.forEach(item=>{
          const key = (item.dataset.key||"").trim().toLowerCase();
          const input = item.querySelector('input');
          if(!input) return;
          const val = (input.value||"").trim().toLowerCase();
          if(key){ total++; }
          if(val===key){
            score++;
            input.classList.add('correct'); input.classList.remove('incorrect');
          }else{
            input.classList.add('incorrect'); input.classList.remove('correct');
          }
        });
        alert(`Ù†Ù…Ø±Ù‡â€ŒÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±: ${score} Ø§Ø² ${total}.`);
      });

      glShow.addEventListener('click', ()=>{
        glBody.querySelectorAll('.answer').forEach(a=> a.classList.add('show'));
      });

      glClear.addEventListener('click', ()=>{
        glBody.querySelectorAll('.exercise input').forEach(i=>{
          i.value = "";
          i.classList.remove('correct','incorrect');
        });
        glBody.querySelectorAll('.answer').forEach(a=> a.classList.remove('show'));
      });

      // Glossary search + speak
      glInput.addEventListener('input', ()=>{
        const q = (glInput.value||"").trim().toLowerCase();
        if(!q){
          glResult.innerHTML = `<div style="color:${getComputedStyle(document.body).getPropertyValue('--muted')}">ÛŒÚ© ÙˆØ§Ú˜Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...</div>`;
          return;
        }
        const info = DICT[q];
        glResult.innerHTML = info ? `
          <div><b>ÙˆØ§Ú˜Ù‡:</b> ${q}</div>
          <div><b>Ù…Ø¹Ù†ÛŒ ÙØ§Ø±Ø³ÛŒ:</b> ${info.fa}</div>
          <div><b>Ù…ØªØ±Ø§Ø¯Ùâ€ŒÙ‡Ø§:</b> ${(info.syn||[]).join(", ")}</div>
          <div><b>Ú©Ù„Ù…Ø§Øª Ù…Ø±ØªØ¨Ø·:</b> ${(info.rel||[]).join(", ")}</div>
          <div><b>Ù…Ø«Ø§Ù„ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ:</b> ${info.ex}</div>
        ` : `ÙˆØ±ÙˆØ¯ÛŒ Ø¨Ø±Ø§ÛŒ "<b>${q}</b>" ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¢Ù† Ø±Ø§ Ø¨Ù‡ DICT Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.`;
      });
      glSpeak.addEventListener('click', ()=>{
        const q = (glInput.value||"").trim();
        if(q) speak(q);
      });

      // Popup
      popupClose.addEventListener('click', ()=> wordPopup.classList.add('hidden'));
      popupSpeak.addEventListener('click', ()=> speak(popupWord.textContent));

      // Global ESC to close
      document.addEventListener('keydown', (e)=>{
        if(e.key==='Escape'){
          helpModal.classList.add('hidden');
          verbsModal.classList.add('hidden');
          glossaryModal.classList.add('hidden');
          wordPopup.classList.add('hidden');
        }
        if(e.key==='ArrowRight') turnPage(1);
        if(e.key==='ArrowLeft') turnPage(-1);
      });

      /* ---------- Lesson / pages ---------- */
      function loadLesson(id){
        const lesson = LESSONS.find(l=>l.id===id);
        if(!lesson){ alert("Lesson not found"); return; }
        startScreen.classList.add('hidden');
        flipbookArea.classList.remove('hidden');
        currentTitleEl.textContent = lesson.title;
        pages = buildPages(lesson);
        pageIndex = 0;
        renderPages();
      }

      function buildPages(lesson){
        return lesson.sections.map(sec=> sectionToPage(sec));
      }

      function renderPages(){
        flipbookEl.innerHTML = "";
        pages.forEach((pageHTML, idx)=>{
          const el = document.createElement('div');
          el.className = 'page';
          el.dataset.index = idx;
          el.innerHTML = pageHTML;
          flipbookEl.appendChild(el);
        });
        bindPageEvents();
        highlightPage();
      }

      function bindPageEvents(){
        flipbookEl.querySelectorAll('.word').forEach(w=>{
          w.addEventListener('click', ()=> showWord(w.textContent.trim().toLowerCase()));
        });
        flipbookEl.querySelectorAll('.reveal').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const ans = btn.closest('.exercise').querySelector('.answer');
            ans.classList.toggle('show');
          });
        });
        flipbookEl.querySelectorAll('.check').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const item = btn.closest('.exercise');
            const input = item.querySelector('input, textarea, select');
            const key = (item.dataset.key||"").trim().toLowerCase();
            if(!input) return;
            const val = (input.value||"").trim().toLowerCase();
            if(val===key || key.includes(val)){
              input.classList.add('correct'); input.classList.remove('incorrect');
            }else{
              input.classList.add('incorrect'); input.classList.remove('correct');
            }
          });
        });
      }

      function highlightPage(){
        flipbookEl.querySelectorAll('.page').forEach((p,i)=>{
          p.style.opacity = (i===pageIndex) ? '1' : '0';
          p.style.pointerEvents = (i===pageIndex) ? 'auto' : 'none';
          p.style.transition = 'opacity .25s';
        });
      }
      function turnPage(dir){
        const next = pageIndex + dir;
        if(next<0 || next>=pages.length) return;
        pageIndex = next;
        highlightPage();
      }

      function sectionToPage(sec){
        const title = `<h2>${sec.title}</h2>`;
        let body = "";
        if(sec.type==="conversation"){
          body += `<div class="section"><h3>${sec.title}</h3><div class="text">${inlineWords(nl(sec.text))}</div></div>`;
        }
        if(sec.type==="practice"){
          body += `<div class="section"><h3>${sec.title}</h3>
            ${sec.items.map(it=>`
              <div class="exercise" data-key="${(it.a||'').toLowerCase()}">
                <div><b>Q:</b> ${inlineWords(it.q)}</div>
                <div class="controls">
                  <input type="text" placeholder="Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯"/>
                  <button class="btn btn--ghost check">Ø¨Ø±Ø±Ø³ÛŒ</button>
                  <button class="btn btn--outline reveal">Ù†Ù…Ø§ÛŒØ´ Ù¾Ø§Ø³Ø®</button>
                </div>
                <div class="answer"><b>Answer:</b> ${it.a}</div>
              </div>
            `).join("")}
          </div>`;
        }
        if(sec.type==="listening"){
          body += `<div class="section"><h3>${sec.title}</h3>
            <div class="text">${inlineWords(nl(sec.text))}</div>
          </div>`;
        }
        return `${title}${body}`;
      }

      function inlineWords(text){
        return String(text).replace(/\b([A-Za-z][A-Za-z\-']+)\b/g,(m)=>`<span class="word">${m}</span>`);
      }
      function nl(str){ return String(str).replace(/\n/g,"<br/>"); }

      function showWord(word){
        const info = DICT[word];
        popupWord.textContent = word;
        popupBody.innerHTML = info ? `
          <div>Ù…Ø¹Ù†ÛŒ ÙØ§Ø±Ø³ÛŒ: <b>${info.fa}</b></div>
          <div>Ù…ØªØ±Ø§Ø¯Ùâ€ŒÙ‡Ø§: ${(info.syn||[]).join(", ")}</div>
          <div>Ú©Ù„Ù…Ø§Øª Ù…Ø±ØªØ¨Ø·: ${(info.rel||[]).join(", ")}</div>
          <div>Ù…Ø«Ø§Ù„ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ: ${info.ex}</div>
        ` : `ÙˆØ§Ú˜Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ "${word}" Ø±Ø§ Ø¨Ù‡ DICT Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.`;
        wordPopup.classList.remove('hidden');
      }

      function speak(text){
        if(!window.speechSynthesis){ alert("Speech Synthesis Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯."); return; }
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        window.speechSynthesis.speak(u);
      }

      /* ---------- Irregular verbs ---------- */
      function renderIrregular(){
        verbsBody.innerHTML = [
          { base:"be", past:"was/were", exEn:"I was happy.", exFa:"Ù…Ù† Ø®ÙˆØ´Ø­Ø§Ù„ Ø¨ÙˆØ¯Ù…." },
          { base:"go", past:"went", exEn:"She went home.", exFa:"Ø§Ùˆ Ø¨Ù‡ Ø®Ø§Ù†Ù‡ Ø±ÙØª." },
          { base:"break", past:"broke", exEn:"He broke his leg.", exFa:"Ø§Ùˆ Ù¾Ø§ÛŒØ´ Ø±Ø§ Ø´Ú©Ø³Øª." },
          { base:"buy", past:"bought", exEn:"Ø¢Ù†â€ŒÙ‡Ø§ ØºØ°Ø§ Ø®Ø±ÛŒØ¯Ù†Ø¯.", exFa:"Ø¢Ù†â€ŒÙ‡Ø§ ØºØ°Ø§ Ø®Ø±ÛŒØ¯Ù†Ø¯." }
        ].map(v=>`
          <div class="exercise">
            <div><b>Base:</b> ${v.base} â€” <b>Past:</b> ${v.past}</div>
            <div style="margin-top:6px"><b>EN:</b> ${v.exEn}</div>
            <div><b>FA:</b> ${v.exFa}</div>
          </div>
        `).join("");
      }

      // Flipbook back
      backBtn.addEventListener('click', ()=>{
        flipbookArea.classList.add('hidden');
        startScreen.classList.remove('hidden');
      });
    });
  </script>
  <script>
document.addEventListener("DOMContentLoaded", function () {
  // 1) Ù‡Ù…ÛŒØ´Ù‡ Ø¯Ú©Ù…Ù‡ Ø¨Ø³ØªÙ† Ø±Ø§ Ø¨Ù‡ Ø­Ø§Ù„Øª button ØªØ¨Ø¯ÛŒÙ„ Ú©Ù†
  const glCloseBtn = document.getElementById("glClose");
  if (glCloseBtn) glCloseBtn.setAttribute("type","button");

  // 2) Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡â€ŒØ±ÙˆÛŒØ¯Ø§Ø¯: Ù‡Ø± Ú©Ù„ÛŒÚ©ÛŒ Ø±ÙˆÛŒ ØµÙØ­Ù‡ Ø§Ú¯Ø± Ø¯Ú©Ù…Ù‡ Ø¨Ø³ØªÙ† Ø¨ÙˆØ¯ØŒ Ù…ÙˆØ¯Ø§Ù„ Ø±Ø§ Ø¨Ø¨Ù†Ø¯
  document.addEventListener("click", function (e) {
    const closeBtn = e.target.closest("#glClose");
    if (closeBtn) {
      e.preventDefault();
      e.stopPropagation();

      // Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ù…ÙˆØ¯Ø§Ù„ ÙˆØ§Ù„Ø¯ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ù† (Ø§Ú¯Ø± Ú†Ù†Ø¯ Ù…ÙˆØ¯Ø§Ù„ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯)
      const modal = closeBtn.closest(".modal");
      if (modal) modal.classList.add("hidden");
    }
  });

  // 3) Ú©Ù„ÛŒÚ© Ø¨ÛŒØ±ÙˆÙ† Ø§Ø² Ù¾Ù†Ø¬Ø±Ù‡ØŒ Ù…ÙˆØ¯Ø§Ù„ Ø±Ø§ Ø¨Ø¨Ù†Ø¯Ø¯ (Ø¨Ù‡â€ŒØ·ÙˆØ± Ø§ÛŒÙ…Ù†)
  const glossaryModal = document.getElementById("glossaryModal");
  if (glossaryModal) {
    glossaryModal.addEventListener("click", function (e) {
      const content = glossaryModal.querySelector(".modal-content");
      if (!content) return;
      if (!content.contains(e.target)) glossaryModal.classList.add("hidden");
    });
  }

  // 4) Ú©Ù„ÛŒØ¯ Escape Ù‡Ù… Ø¨Ø¨Ù†Ø¯Ø¯
  document.addEventListener("keydown", function (e) {
    if (e.key === "Escape") {
      const openModal = document.querySelector(".modal:not(.hidden)");
      if (openModal) openModal.classList.add("hidden");
    }
  });

  // 5) Ø§ÛŒÙ…Ù†ÛŒÙ Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§: Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ú©Ù„ÛŒÚ©â€ŒÙ¾Ø°ÛŒØ±ÛŒ
  const style = document.createElement("style");
  style.textContent = `
    .modal { z-index: 1000; }
    .modal-content { position: relative; z-index: 1001; }
    .modal * { pointer-events: auto; }
    button#glClose { pointer-events: auto; }
  `;
  document.head.appendChild(style);
});
</script>
</body>
</html>
